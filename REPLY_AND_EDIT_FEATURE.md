# 飞书机器人立即回复和消息编辑功能

## 功能说明

已实现以下两个新功能：

1. **立即回复功能** - 用户发送消息后，机器人立即回复"正在思考中，请稍候..."
2. **消息编辑功能** - 获取Claude回复后，机器人会编辑之前的"思考中"消息，更新为实际回复内容

## 实现流程

### 1. 立即回复 (replyToFeishu)
- 在 `services/messageService.js` 中实现
- 在异步队列中发送"正在思考中，请稍候..."
- **重要**: 不会阻塞飞书的HTTP 200响应
- 设置3秒超时保护，避免网络问题导致的长时间阻塞
- 返回消息ID用于后续编辑

### 2. 消息编辑 (editMessage)
- 在 `services/messageService.js` 中实现
- 使用飞书消息更新API编辑已发送的消息
- 支持自动token管理，无需手动传递tenant_token

### 3. 集成到事件处理流程
- **优化后**: `index_modular.js` 中只标记需要立即回复，不实际发送
- 在 `utils/eventQueue.js` 中异步处理立即回复和Claude回复
- 优先尝试编辑消息，失败时自动降级为发送新消息

## 性能优化

### 🚀 非阻塞设计
- 立即回复不会影响飞书的即时响应（HTTP 200）
- 所有网络操作都在异步队列中执行
- 事件处理器可以立即返回，避免飞书重试

### ⏱️ 超时保护
- 立即回复设置3秒超时
- 超时后仍会继续处理Claude回复
- 确保用户体验的连续性

## 使用方式

功能已自动集成到现有的消息处理流程中：

1. 用户发送消息给机器人
2. 机器人立即回复："正在思考中，请稍候..."
3. 后台异步调用Claude API获取回复
4. 机器人编辑之前的"思考中"消息，更新为Claude的实际回复
5. 如果编辑失败，会发送新的回复消息

## 优势

- **用户体验更好** - 立即反馈让用户知道消息已收到
- **对话更连贯** - 编辑消息比发送新消息更自然
- **容错性强** - 编辑失败时自动降级为发送新消息
- **兼容性好** - 不影响现有功能，完全向后兼容

## 文件修改说明

- `services/messageService.js`: 新增 `replyToFeishu()` 和 `editMessage()` 函数
- `index_modular.js`: 集成立即回复功能到事件处理流程
- `utils/eventQueue.js`: 修改异步处理逻辑，优先尝试消息编辑